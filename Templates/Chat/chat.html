{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>codePinion ::- Chat</title>

    <!--Font is poppins-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

    <!--The ajax link-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.js" integrity="sha512-n/4gHW3atM3QqRcbCn6ewmpxcLAHGaDjpEBu4xZd47N0W2oQ+6q7oc3PXstrJYXcbNU1OHdQ1T7pAP+gi5Yu8g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!--The css file-->
    <link rel="stylesheet" href="{% static '/Css/chat.css' %}">

    <!--Bootstrap css link-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>


</head>
<body>

    <!--This is the bigest section-->
    <div class="chat">

        <!--The chat navigation-->
        <div class="chatNav">

            <!--The inner nav-->
            <div class="innerNav">

                <!--The code pinion icon-->
                <div class="icon">
                    
                    <!--The image itself-->
                    <div class="icImg">
                        <img src="{% static 'Images\Icon\csIcon.jpg' %}" alt="">
                    </div>

                </div>

                <!--The actual navigation-->
                <div class="actNav">

                    <!--the navigation icons-->
                    <!--Home-->
                    <a href="{% url 'New_questions' %}">
                        <div class="navSvgs">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M21 13v10h-6v-6h-6v6h-6v-10h-3l12-12 12 12h-3zm-1-5.907v-5.093h-3v2.093l3 3z"/></svg>
                        </div>
                    </a>

                    <!--Inbox-->
                    <a href="{% url 'rooms' %}">
                        <div class="navSvgs">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M2.688 6l-.688-2h20l-.604 2h-18.708zm17.541-4l.739-2h-17.968l.792 2h16.437zm2.162 8l.609-2h-22l.609 2h20.782zm-5.391 2l-2.25 3h-5.5l-2.25-3h-7l2 12h20l2-12h-7z"/></svg>
                        </div>
                    </a>

                    <!--Video Chat-->
                    <a href="{% url 'videos' %}">
                        <div class="navSvgs">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M16 18c0 1.104-.896 2-2 2h-12c-1.105 0-2-.896-2-2v-12c0-1.104.895-2 2-2h12c1.104 0 2 .896 2 2v12zm8-14l-6 6.223v3.554l6 6.223v-16z"/></svg>
                        </div>
                    </a>

                    <!--Share screen-->
                    <a href="{% url 'shares' %}">
                        <div class="navSvgs">
                            <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd"><path d="M24 8.2c0-.318-.126-.623-.351-.849-.226-.225-.531-.351-.849-.351h-6.6c-.318 0-.623.126-.849.351-.225.226-.351.531-.351.849v13.6c0 .318.126.623.351.849.226.225.531.351.849.351h6.6c.318 0 .623-.126.849-.351.225-.226.351-.531.351-.849v-13.6zm-11 14.8h-8l2.599-3h5.401v3zm6.5-1c-.553 0-1-.448-1-1s.447-1 1-1c.552 0 .999.448.999 1s-.447 1-.999 1zm3.5-3v-9.024h-7v9.024h7zm-2-14h-2v-2h-17v13h11v2h-13v-17h21v4zm-.5 4c.276 0 .5-.224.5-.5s-.224-.5-.5-.5h-2c-.276 0-.5.224-.5.5s.224.5.5.5h2z"/></svg>
                        </div>
                    </a>

                    <!--Settings-->
                    <div class="navSvgs">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M17 10.645v-2.29c-1.17-.417-1.907-.533-2.28-1.431-.373-.9.07-1.512.6-2.625l-1.618-1.619c-1.105.525-1.723.974-2.626.6-.9-.373-1.017-1.116-1.431-2.28h-2.29c-.412 1.158-.53 1.907-1.431 2.28h-.001c-.9.374-1.51-.07-2.625-.6l-1.617 1.619c.527 1.11.973 1.724.6 2.625-.375.901-1.123 1.019-2.281 1.431v2.289c1.155.412 1.907.531 2.28 1.431.376.908-.081 1.534-.6 2.625l1.618 1.619c1.107-.525 1.724-.974 2.625-.6h.001c.9.373 1.018 1.118 1.431 2.28h2.289c.412-1.158.53-1.905 1.437-2.282h.001c.894-.372 1.501.071 2.619.602l1.618-1.619c-.525-1.107-.974-1.723-.601-2.625.374-.899 1.126-1.019 2.282-1.43zm-8.5 1.689c-1.564 0-2.833-1.269-2.833-2.834s1.269-2.834 2.833-2.834 2.833 1.269 2.833 2.834-1.269 2.834-2.833 2.834zm15.5 4.205v-1.077c-.55-.196-.897-.251-1.073-.673-.176-.424.033-.711.282-1.236l-.762-.762c-.52.248-.811.458-1.235.283-.424-.175-.479-.525-.674-1.073h-1.076c-.194.545-.25.897-.674 1.073-.424.176-.711-.033-1.235-.283l-.762.762c.248.523.458.812.282 1.236-.176.424-.528.479-1.073.673v1.077c.544.193.897.25 1.073.673.177.427-.038.722-.282 1.236l.762.762c.521-.248.812-.458 1.235-.283.424.175.479.526.674 1.073h1.076c.194-.545.25-.897.676-1.074h.001c.421-.175.706.034 1.232.284l.762-.762c-.247-.521-.458-.812-.282-1.235s.529-.481 1.073-.674zm-4 .794c-.736 0-1.333-.597-1.333-1.333s.597-1.333 1.333-1.333 1.333.597 1.333 1.333-.597 1.333-1.333 1.333zm-4 3.071v-.808c-.412-.147-.673-.188-.805-.505s.024-.533.212-.927l-.572-.571c-.389.186-.607.344-.926.212s-.359-.394-.506-.805h-.807c-.146.409-.188.673-.506.805-.317.132-.533-.024-.926-.212l-.572.571c.187.393.344.609.212.927-.132.318-.396.359-.805.505v.808c.408.145.673.188.805.505.133.32-.028.542-.212.927l.572.571c.39-.186.608-.344.926-.212.318.132.359.395.506.805h.807c.146-.409.188-.673.507-.805h.001c.315-.131.529.025.924.213l.572-.571c-.186-.391-.344-.609-.212-.927s.397-.361.805-.506zm-3 .596c-.552 0-1-.447-1-1s.448-1 1-1 1 .447 1 1-.448 1-1 1z"/></svg>
                    </div>

                </div>

                <!--The current user pictue-->
                <!--The code pinion icon-->
                <div class="icon">
                    
                    <!--The image itself-->
                    <div class="icImg">
                        <img src="{{request.user.profile.profile_url}}" alt="">
                    </div>

                </div>

            </div>

        </div>

        <!--The list of chats-->
        <div class="chatList">

            <!--The list search-->
            <div class="lstSearch">

                <!--The actual search bar-->
                <div class="theSearch">
                    <input type="text" placeholder="Seach">

                    <div class="searchIc">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M23.809 21.646l-6.205-6.205c1.167-1.605 1.857-3.579 1.857-5.711 0-5.365-4.365-9.73-9.731-9.73-5.365 0-9.73 4.365-9.73 9.73 0 5.366 4.365 9.73 9.73 9.73 2.034 0 3.923-.627 5.487-1.698l6.238 6.238 2.354-2.354zm-20.955-11.916c0-3.792 3.085-6.877 6.877-6.877s6.877 3.085 6.877 6.877-3.085 6.877-6.877 6.877c-3.793 0-6.877-3.085-6.877-6.877z"/></svg>
                    </div>

                </div>


            </div>

            <!--The actual users list-->

            <div class="biggerlist">

                <div class="userList">

                    {% for room in rooms %}

                    <a href="{% url 'room' room.slug %}">

                        <!--The actual users-->
                        <div class="actUserList">
        
                            <!--Actual icon-->
                            <div class="listUserIc">
                                {% if room.sender == request.user.profile %}

                                <img src="{{room.receiver.profile_url}}" alt="userProfile">

                                {% elif room.receiver == request.user.profile %}

                                <img src="{{room.sender.profile_url}}" alt="userProfile">

                                {% endif %}

                            </div>
        
        
                            <!--The user name and last message-->
                            <div class="listMessName">

                                {% if room.sender == request.user.profile %}
        
                                <h4>{{room.receiver.full_name}}</h4>

                                {% elif room.receiver == request.user.profile %}

                                <h4>{{room.sender.full_name}}</h4>

                                {% endif %}
        
                                <span>How are You?</span>
        
                            </div>
        
                            <!--The time the message was sent-->
                            <div class="timeList">
                                <span>9:30am</span>
        
                                <div class="listNot">
                                    <p>1</p>
                                </div>
        
                            </div>
        
                        </div>

                    </a>

                    {% endfor %}
    
                        
                </div>

            </div>
            

        </div>

        <!--The convo section-->
        <div class="convo">

            <!--The one to one-->
            <div class="oneToOne">

                <!--Inner convo-->
                <div class="oneInnerC">

                    <!--The one user-->
                    <div class="oneUser">

                        <!--The icon-->
                        <div class="oneIC">
                            {% if request.user.profile.full_name == room.sender.full_name %}

                            <img src="{{room.receiver.profile_url}}" alt="chatUser">

                            {% else %}

                            <img src="{{room.sender.profile_url}}" alt="chatUser">

                            {% endif %}
                        </div>

                        <!--The user and status-->
                        <div class="oneUserStatus">

                            {% if request.user.profile.full_name == room.sender.full_name %}

                            <h4>{{room.receiver.full_name}}</h4>

                            {% else %}

                            <h4>{{room.sender.full_name}}</h4>

                            {% endif %}

                            <!--The status-->
                            <span>Online</span>

                        </div>

                    </div>

                    <!--The user controls-->
                    <div class="oneControls">

                        <!--The icon-->
                        <div class="contIndUc">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M16 18c0 1.104-.896 2-2 2h-12c-1.105 0-2-.896-2-2v-12c0-1.104.895-2 2-2h12c1.104 0 2 .896 2 2v12zm8-14l-6 6.223v3.554l6 6.223v-16z"/></svg>
                        </div>

                        <!--The icon-->
                        <div class="contIndUc">
                            <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd"><path d="M24 8.2c0-.318-.126-.623-.351-.849-.226-.225-.531-.351-.849-.351h-6.6c-.318 0-.623.126-.849.351-.225.226-.351.531-.351.849v13.6c0 .318.126.623.351.849.226.225.531.351.849.351h6.6c.318 0 .623-.126.849-.351.225-.226.351-.531.351-.849v-13.6zm-11 14.8h-8l2.599-3h5.401v3zm6.5-1c-.553 0-1-.448-1-1s.447-1 1-1c.552 0 .999.448.999 1s-.447 1-.999 1zm3.5-3v-9.024h-7v9.024h7zm-2-14h-2v-2h-17v13h11v2h-13v-17h21v4zm-.5 4c.276 0 .5-.224.5-.5s-.224-.5-.5-.5h-2c-.276 0-.5.224-.5.5s.224.5.5.5h2z"/></svg>
                        </div>

                        <!--The icon-->
                        <div class="contIndUc">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M6 12c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3zm9 0c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3zm9 0c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3z"/></svg>
                        </div>


                    </div>

                </div>

            </div>

            <!--The chat section-->
            <div class="chatSecPlace">

                <!--The inner chat section-->
                <div class="innerConvoPlace">

                    <!--The chat place-->
                    <div class="placeChat" id="chat-messages">

                        {% for message in messages %}

                        <!--The actual chat-->
                        <div class="smallChat">

                            <p class="seeUser" >{{message.user.username}}</p>

                            <!--The inner chat-->
                            <!--The sender-->
                            <div class="innerSmallChat">
                                <p>{{message.content}}</p>
                            </div>

                        </div>

                        {% endfor %}

                    </div>


                    <!--Send caht section-->
                    <div class="sendChat">

                        <form method="post" id="sendMessage">

                            {% csrf_token %}

                            <input type="text" name="content" class="formInput" id="chat-message-input" placeholder="Type Your Message...">

                            <!--The buttons-->
                            <!--Form control-->
                            <div class="formControls">

                                <!--The code section-->
                                <button>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-8 10.199l-3.64 1.801 3.64 1.796v2.204l-6-2.935v-2.131l6-2.934v2.199zm8 2.866l-6 2.935v-2.204l3.64-1.796-3.64-1.801v-2.199l6 2.935v2.13z"/></svg>
                                </button>

                                <!--Image section-->
                                <button>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M7 22v-16h14v7.543c0 4.107-6 2.457-6 2.457s1.518 6-2.638 6h-5.362zm16-7.614v-10.386h-18v20h8.189c3.163 0 9.811-7.223 9.811-9.614zm-10 1.614h-4v-1h4v1zm6-4h-10v1h10v-1zm0-3h-10v1h10v-1zm1-7h-17v19h-2v-21h19v2z"/></svg>
                                </button>

                                <!--The submit-->
                                <button id="chat-message-submit" >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M24 0l-6 22-8.129-7.239 7.802-8.234-10.458 7.227-7.215-1.754 24-12zm-15 16.668v7.332l3.258-4.431-3.258-2.901z"/></svg>
                                </button>

                            </div>

                        </form>

                    </div>

                </div>
            </div>

        </div>

        <!--The media section-->
        <div class="chatMedia">

        </div>

    </div>

    {{room.slug|json_script:"json-roomname"}}
    {{request.user.username|json_script:"json-username"}}

    <script>

        const roomName = JSON.parse(document.getElementById('json-roomname').textContent);

        const userName = JSON.parse(document.getElementById('json-username').textContent);

        let allChats = document.querySelectorAll('.smallChat')
        let seeUsers = document.querySelectorAll('.seeUser')
        

        for(let a = 0; a < allChats.length; a++){

            if(seeUsers[a].textContent == userName ){

                allChats[a].classList.add('right');

            }
            else{

                allChats[a].classList.add('left');

            }

        }


        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/'
            + roomName
            + '/'
        );

        chatSocket.onmessage = function(e){
            console.log('onmessage');

            const data = JSON.parse(e.data);

            if(data.message){

                let html = `
                <!--The actual chat-->
                <div class="smallChat">

                    <p class="seeUser" >${data.username}</p>

                    <!--The inner chat-->
                    <!--The sender-->
                    <div class="innerSmallChat">
                        <p>${data.message}</p>
                    </div>

                </div>
                `;

                document.querySelector('#chat-messages').innerHTML += html;

                let allChats = document.querySelectorAll('.smallChat')
                let seeUsers = document.querySelectorAll('.seeUser')
                

                for(let a = 0; a < allChats.length; a++){

                    if(seeUsers[a].textContent == userName ){

                        allChats[a].classList.add('right');

                    }
                    else{

                        allChats[a].classList.add('left');

                    }

                }


            }
            else{
                alert('The message was empty')
            }

        }

        chatSocket.onclose = function(e){
            console.log('onclose')
        }


        //


        document.querySelector('#chat-message-submit').onclick = function(e){

            e.preventDefault();

            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;

            chatSocket.send(JSON.stringify({
                'message':message,
                'username': userName,
                'room': roomName,
                //'action':''
            }));
            messageInputDom.value = '';

        }

    </script>
    
</body>
</html>